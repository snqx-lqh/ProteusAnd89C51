## 05_串口中断实验

### 串口基础

串口是一种全双工的通信方式，意思就是可以在发的时候也接收，两台设备连接，己方设备TX连接对方设备RX，己方设备RX连接对方设备TX，然后只要配置的参数一样就可以通信了，常规的通信是1个字节8位的传输。

### 串口基础配置

串口配置相关寄存器如下。

PCON最高位在这里控制串口波特率是否加倍，比如后面算出来是4800，如果这里配置加倍，最后就是9600

SCON配置UART的位数，和工作方式，通常都是8位，和波特率可设置的方式

TMOD配置定时器模式，串口波特率需要定时器1产生。

```c
void UartInit(void)		//9600bps@11.0592MHz
{
	PCON &= 0x7F;		//波特率不倍速
	SCON = 0x50;		//8位数据,可变波特率
	TMOD &= 0x0F;		//设置定时器模式
	TMOD |= 0x20;		//设置定时器模式
	TL1 = 0xFD;			//设置定时初始值
	TH1 = 0xFD;			//设置定时重载值
	ET1 = 0;			//禁止定时器中断
	TR1 = 1;			//定时器1开始计时
	ES = 1;             //打开串口中断
	EA = 1;             //打开全部中断
}
```

串口中断服务函数，串口中断会把接收到的数据存放在SBUF里面，RI是接收中断标志位，处理完后需要清零。

```c
void UartRoutine(void) interrupt 4
{
	u8 res;	
	if(RI)
	{
		res = SBUF;
		RI = 0;
	}	
}
```

串口发送的时候，也是使用SBUF，给SBUF赋值，然后TI为1的时候，就是发送完成了，这时候再把发送的标志位置0。

```c
void SendBuffLen(u8 *str,u8 len)
{
	while(len != 0)
	{
		SBUF = *str;
		while(!TI);
		TI = 0;
		str++;
		len --;
	}
}
```

